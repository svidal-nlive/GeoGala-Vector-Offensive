!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver(t=>{for(const i of t)if("childList"===i.type)for(const t of i.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&e(t)}).observe(document,{childList:!0,subtree:!0})}function e(t){if(t.ep)return;t.ep=!0;const e=function(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),"use-credentials"===t.crossOrigin?e.credentials="include":"anonymous"===t.crossOrigin?e.credentials="omit":e.credentials="same-origin",e}(t);fetch(t.href,e)}}();const t="#0b1020",e="#00ff88",i="#ff1744",s="#ffeb3b",a="#e8f0ff",r="#ff6b8b",h=.15,n=6,o=1,l=1,c=15,d=50;class u{canvas;ctx;dpr;width;height;constructor(t){const e=document.getElementById(t);if(!e)throw new Error(`Canvas element with id "${t}" not found`);this.canvas=e,this.ctx=e.getContext("2d"),this.dpr=window.devicePixelRatio||1,this.width=e.clientWidth,this.height=e.clientHeight,e.width=this.width*this.dpr,e.height=this.height*this.dpr,this.ctx.scale(this.dpr,this.dpr),e.style.width=`${this.width}px`,e.style.height=`${this.height}px`}clear(){this.ctx.fillStyle=t,this.ctx.fillRect(0,0,this.width,this.height)}drawTriangle(t,e,i,s,a){this.ctx.save(),this.ctx.translate(t,e),this.ctx.rotate(s),this.ctx.fillStyle=a,this.ctx.beginPath(),this.ctx.moveTo(0,-i),this.ctx.lineTo(i,i),this.ctx.lineTo(-i,i),this.ctx.closePath(),this.ctx.fill(),this.ctx.restore()}drawCircle(t,e,i,s){this.ctx.fillStyle=s,this.ctx.beginPath(),this.ctx.arc(t,e,i,0,2*Math.PI),this.ctx.fill()}drawRect(t,e,i,s,a){this.ctx.fillStyle=a,this.ctx.fillRect(t,e,i,s)}drawText(t,e,i,s,r=a){this.ctx.fillStyle=r,this.ctx.font=`${s}px monospace`,this.ctx.textAlign="left",this.ctx.fillText(t,e,i)}drawTextCentered(t,e,i,s,r=a){this.ctx.fillStyle=r,this.ctx.font=`${s}px monospace`,this.ctx.textAlign="center",this.ctx.fillText(t,e,i)}getWidth(){return this.width}getHeight(){return this.height}getContext(){return this.ctx}}class m{wave=0;score=0;multiplier=1;comboCounter=0;noHitWave=!0;resources={scrap:0,synergy:0,rare:0};workshopUpgrades=new Map;isRunActive=!1;bestScore=0;runCount=0;constructor(){this.loadWorkshopUpgrades(),this.loadRunStats()}startRun(){this.wave=1,this.score=0,this.multiplier=1,this.comboCounter=0,this.noHitWave=!0,this.resources={scrap:0,synergy:0,rare:0},this.isRunActive=!0,this.runCount++,this.saveRunStats()}endRun(){this.isRunActive=!1,this.score>this.bestScore&&(this.bestScore=this.score,this.saveRunStats())}nextWave(){this.wave++,this.multiplier=Math.min(2,1+.1*(this.wave-1)),this.noHitWave&&(this.score=Math.floor(1.1*this.score)),this.noHitWave=!0}onPlayerHit(){this.noHitWave=!1}addScore(t){this.score+=Math.floor(t*this.multiplier)}addResources(t,e){this.resources[t]+=e}addWorkshopUpgrade(t){this.workshopUpgrades.set(t.id,t)}getUpgrade(t){return this.workshopUpgrades.get(t)}saveWorkshopUpgrades(){const t=Array.from(this.workshopUpgrades.values());try{localStorage.setItem("geogala_workshop",JSON.stringify(t))}catch(e){}}loadWorkshopUpgrades(){try{const t=localStorage.getItem("geogala_workshop");if(t){const e=JSON.parse(t);this.workshopUpgrades.clear(),e.forEach(t=>{this.workshopUpgrades.set(t.id,t)})}}catch(t){this.workshopUpgrades.clear()}}clearRun(){this.wave=0,this.score=0,this.multiplier=1,this.comboCounter=0,this.noHitWave=!0,this.resources={scrap:0,synergy:0,rare:0},this.isRunActive=!1}loadRunStats(){try{const t=localStorage.getItem("geogala_run_stats");if(t){const e=JSON.parse(t);this.bestScore=e.bestScore||0,this.runCount=e.runCount||0}}catch(t){}}saveRunStats(){try{const t={bestScore:this.bestScore,runCount:this.runCount};localStorage.setItem("geogala_run_stats",JSON.stringify(t))}catch(t){}}}class p{keyPressed=new Set;gamepadState={x:0,y:0,fire:!1};pointerState={x:0,y:0,active:!1,fire:!1};canvas;touchIdentifier=null;constructor(t){this.canvas=t,this.setupKeyboardListeners(),this.setupPointerListeners()}setupKeyboardListeners(){window.addEventListener("keydown",t=>{this.keyPressed.add(t.key.toLowerCase())}),window.addEventListener("keyup",t=>{this.keyPressed.delete(t.key.toLowerCase())})}setupPointerListeners(){this.canvas.addEventListener("pointerdown",t=>{this.handlePointerStart(t)}),this.canvas.addEventListener("pointermove",t=>{this.handlePointerMove(t)}),this.canvas.addEventListener("pointerup",t=>{this.handlePointerEnd(t)}),this.canvas.addEventListener("touchstart",t=>{t.touches.length>0&&(this.touchIdentifier=t.touches[0].identifier)})}handlePointerStart(t){this.pointerState.active=!0,this.pointerState.x=t.clientX,this.pointerState.y=t.clientY,t.isPrimary&&(this.pointerState.fire=!0)}handlePointerMove(t){this.pointerState.active&&(this.pointerState.x=t.clientX,this.pointerState.y=t.clientY)}handlePointerEnd(t){t.isPrimary&&(this.pointerState.active=!1,this.pointerState.fire=!1)}pollGamepad(){const t=navigator.getGamepads();if(!t||0===t.length)return void(this.gamepadState={x:0,y:0,fire:!1});const e=t[0];if(!e||!e.connected)return void(this.gamepadState={x:0,y:0,fire:!1});const[i,s]=function(t,e,i){const s=Math.sqrt(t*t+e*e);if(s<i)return[0,0];const a=(s-i)/(1-i),r=Math.atan2(e,t);return[Math.cos(r)*a,Math.sin(r)*a]}(e.axes[0],e.axes[1],h),a=e.buttons[0]?.pressed||!1;this.gamepadState={x:i,y:s,fire:a}}getInput(){if(this.pollGamepad(),0!==this.gamepadState.x||0!==this.gamepadState.y)return{x:this.gamepadState.x,y:this.gamepadState.y,fire:this.gamepadState.fire};let t=0,e=0;(this.keyPressed.has("w")||this.keyPressed.has("arrowup"))&&(e-=1),(this.keyPressed.has("s")||this.keyPressed.has("arrowdown"))&&(e+=1),(this.keyPressed.has("a")||this.keyPressed.has("arrowleft"))&&(t-=1),(this.keyPressed.has("d")||this.keyPressed.has("arrowright"))&&(t+=1);const i=this.keyPressed.has(" ");if(0!==t||0!==e){const s=Math.sqrt(t*t+e*e);return{x:t/s,y:e/s,fire:i}}if(this.pointerState.active){const t=this.canvas.getBoundingClientRect(),e=t.width/2,i=t.height/2,s=this.pointerState.x-t.left-e,a=this.pointerState.y-t.top-i,r=Math.sqrt(s*s+a*a);if(r>0)return{x:s/r,y:a/r,fire:this.pointerState.fire}}return{x:0,y:0,fire:!1}}isKeyPressed(t){return this.keyPressed.has(t.toLowerCase())}shutdown(){this.keyPressed.clear(),this.gamepadState={x:0,y:0,fire:!1},this.pointerState={x:0,y:0,active:!1,fire:!1}}}class g{audioContext=null;masterGain=null;musicGain=null;sfxGain=null;sfxPool={available:[],playing:new Set};musicSource=null;contextResumeAttempted=!1;buffers=new Map;musicBaseGain=.5;musicDuckedGain=.3;duckingRampTime=.1;constructor(){this.tryInitContext()}tryInitContext(){try{const t=new(window.AudioContext||window.webkitAudioContext);this.audioContext=t,this.masterGain=t.createGain(),this.masterGain.gain.value=o,this.masterGain.connect(t.destination),this.musicGain=t.createGain(),this.musicGain.gain.value=this.musicBaseGain,this.musicGain.connect(this.masterGain),this.sfxGain=t.createGain(),this.sfxGain.gain.value=.8,this.sfxGain.connect(this.masterGain);for(let e=0;e<n;e++){const e=t.createBufferSource();this.sfxPool.available.push(e)}}catch{}}async resumeContext(){if(!this.contextResumeAttempted&&this.audioContext){this.contextResumeAttempted=!0;try{"suspended"===this.audioContext.state&&await this.audioContext.resume()}catch{}}}async loadAudio(t){if(!this.audioContext)return null;try{const e=await window.fetch(t),i=await e.arrayBuffer();return await this.audioContext.decodeAudioData(i)}catch{return null}}async loadAndCacheAudio(t,e){if(this.buffers.has(t))return;const i=await this.loadAudio(e);i&&this.buffers.set(t,i)}playSfx(t){if(!this.audioContext||!this.sfxGain)return;let e=this.sfxPool.available.pop();e||(e=this.audioContext.createBufferSource()),e.buffer=t,e.connect(this.sfxGain),this.sfxPool.playing.add(e),this.applyMusicDucking(!0),e.onended=()=>{this.sfxPool.playing.delete(e),this.sfxPool.available.push(e),0===this.sfxPool.playing.size&&this.applyMusicDucking(!1)},e.start()}playSfxByKey(t){const e=this.buffers.get(t);e&&this.playSfx(e)}applyMusicDucking(t){if(!this.musicGain||!this.audioContext)return;const e=t?this.musicDuckedGain:this.musicBaseGain,i=this.audioContext.currentTime;this.musicGain.gain.cancelScheduledValues(i),this.musicGain.gain.setValueAtTime(this.musicGain.gain.value,i),this.musicGain.gain.exponentialRampToValueAtTime(e,i+this.duckingRampTime)}playMusic(t,e=!0){this.audioContext&&this.musicGain&&(this.musicSource&&this.musicSource.stop(),this.musicSource=this.audioContext.createBufferSource(),this.musicSource.buffer=t,this.musicSource.loop=e,this.musicSource.connect(this.musicGain),this.musicSource.start())}playMusicByKey(t,e=!0){const i=this.buffers.get(t);i&&this.playMusic(i,e)}stopMusic(){this.musicSource&&(this.musicSource.stop(),this.musicSource=null)}setMasterGain(t){this.masterGain&&(this.masterGain.gain.value=Math.max(0,Math.min(1,t)))}getMasterGain(){return this.masterGain?.gain.value||0}getContextState(){return this.audioContext?.state||"closed"}}class y{pairs=[];checkCollisions(t){this.pairs=[];for(let e=0;e<t.length;e++)if(t[e].alive)for(let i=e+1;i<t.length;i++)t[i].alive&&this.checkCollision(t[e],t[i])&&this.pairs.push({a:t[e],b:t[i]});return this.pairs}checkCollision(t,e){return function(t,e,i,s,a,r){const h=s-t,n=a-e;return h*h+n*n<(i+r)*(i+r)}(t.x,t.y,t.radius,e.x,e.y,e.radius)}getPairs(){return this.pairs}}class f{x=0;y=0;vx=0;vy=0;radius=5;alive=!1;constructor(){}reset(t,e,i,s,a=5){this.x=t,this.y=e,this.vx=i,this.vy=s,this.radius=a,this.alive=!0}deactivate(){this.alive=!1}update(t){this.x+=this.vx*t,this.y+=this.vy*t}draw(t){}getBoundingBox(){return{x:this.x-this.radius,y:this.y-this.radius,width:2*this.radius,height:2*this.radius}}}class v{pool=[];active=[];entityFactory;constructor(t,e){this.entityFactory=e;for(let i=0;i<t;i++)this.pool.push(e())}acquire(t,e,i,s,a){let r;return r=this.pool.length>0?this.pool.pop():this.entityFactory(),r.reset(t,e,i,s,a),this.active.push(r),r}release(t){t.deactivate();const e=this.active.indexOf(t);e>-1&&(this.active.splice(e,1),this.pool.push(t))}getActive(){return this.active}clear(){this.active.forEach(t=>{t.deactivate(),this.pool.push(t)}),this.active=[]}update(t){for(let e=this.active.length-1;e>=0;e--){const i=this.active[e];i.update(t),(i.x<-50||i.x>800||i.y<-50||i.y>600)&&this.release(i)}}draw(t){this.active.forEach(e=>{e.alive&&e.draw(t)})}}class x extends f{health=100;maxHealth=100;fireRate=.1;timeSinceLastFire=0;aimAngle=0;maxSpeed=450;acceleration=2200;deceleration=1800;fireFlash=!1;damageFlashTimer=0;targetVx=0;targetVy=0;constructor(){super(),this.radius=15}reset(t,e){super.reset(t,e,0,0),this.health=this.maxHealth,this.timeSinceLastFire=0,this.aimAngle=0,this.fireFlash=!1,this.damageFlashTimer=0,this.targetVx=0,this.targetVy=0}update(t){const e=this.targetVx-this.vx,i=this.targetVy-this.vy;if(Math.abs(e)>.1||Math.abs(i)>.1){const s=this.acceleration*t;this.vx+=Math.sign(e)*Math.min(Math.abs(e),s),this.vy+=Math.sign(i)*Math.min(Math.abs(i),s)}else{const e=this.deceleration*t;Math.abs(this.vx)>e?this.vx-=Math.sign(this.vx)*e:this.vx=0,Math.abs(this.vy)>e?this.vy-=Math.sign(this.vy)*e:this.vy=0}this.x+=this.vx*t,this.y+=this.vy*t,this.timeSinceLastFire+=t,this.fireFlash&&(this.fireFlash=!1),this.damageFlashTimer>0&&(this.damageFlashTimer-=t)}updateInput(t,e){const i=Math.sqrt(t*t+e*e);i>0?(this.targetVx=t/i*this.maxSpeed,this.targetVy=e/i*this.maxSpeed,this.aimAngle=Math.atan2(e,t)):(this.targetVx=0,this.targetVy=0)}canFire(){return this.timeSinceLastFire>=this.fireRate}fire(){this.timeSinceLastFire=0,this.fireFlash=!0}takeDamage(t){this.health=Math.max(0,this.health-t),this.damageFlashTimer=.2,this.health<=0&&(this.alive=!1)}draw(t){if(!this.alive)return;t.save(),t.translate(this.x,this.y),t.rotate(this.aimAngle+Math.PI/2),this.fireFlash&&(t.shadowColor="#ffffff",t.shadowBlur=15);const i=this.damageFlashTimer>0&&Math.floor(10*this.damageFlashTimer)%2==0;t.fillStyle=i?"#ff1744":e,t.beginPath(),t.moveTo(0,-this.radius),t.lineTo(.7*this.radius,this.radius),t.lineTo(.7*-this.radius,this.radius),t.closePath(),t.fill(),this.health>.5*this.maxHealth&&(t.strokeStyle="rgba(0, 255, 136, 0.3)",t.lineWidth=2,t.beginPath(),t.arc(0,0,this.radius+3,0,2*Math.PI),t.stroke()),t.restore()}}class w extends f{faction="triangle";health=20;maxHealth=20;fireRate=.5;timeSinceLastFire=0;loot={scrap:10,synergy:0,rare:0};aiTimer=0;aiAngle=0;baseSpeed=150;damageFlashTimer=0;deathAnimTimer=0;isDying=!1;constructor(t="triangle"){super(),this.faction=t,this.radius=12,this.assignFactionStats()}assignFactionStats(){switch(this.faction){case"triangle":this.maxHealth=20,this.health=20,this.fireRate=.5,this.loot={scrap:10,synergy:0,rare:0};break;case"square":this.maxHealth=30,this.health=30,this.fireRate=.4,this.loot={scrap:15,synergy:1,rare:0};break;case"hexagon":this.maxHealth=40,this.health=40,this.fireRate=.3,this.loot={scrap:20,synergy:2,rare:0};break;case"diamond":this.maxHealth=50,this.health=50,this.fireRate=.2,this.loot={scrap:25,synergy:3,rare:1}}}reset(t,e,i,s){super.reset(t,e,i,s),this.health=this.maxHealth,this.timeSinceLastFire=0,this.aiTimer=0,this.aiAngle=0,this.damageFlashTimer=0,this.deathAnimTimer=0,this.isDying=!1,this.assignFactionStats()}update(t){if(this.timeSinceLastFire+=t,this.aiTimer+=t,this.damageFlashTimer>0&&(this.damageFlashTimer-=t),this.isDying)return this.deathAnimTimer+=t,void(this.deathAnimTimer>=.3&&(this.alive=!1));this.updateAI(t),this.x+=this.vx*t,this.y+=this.vy*t}updateAI(t){switch(this.faction){case"triangle":break;case"square":this.vx=100*Math.sin(2*this.aiTimer),this.vy=this.baseSpeed;break;case"hexagon":this.aiAngle+=2*t,this.vx=80*Math.cos(this.aiAngle),this.vy=.8*this.baseSpeed;break;case"diamond":this.aiTimer%1<t&&(this.aiAngle=Math.random()*Math.PI*2),this.vx=120*Math.cos(this.aiAngle),this.vy=60*Math.sin(this.aiAngle)+.5*this.baseSpeed}}canFire(){return this.timeSinceLastFire>=this.fireRate}fire(){this.timeSinceLastFire=0}takeDamage(t){this.health=Math.max(0,this.health-t),this.damageFlashTimer=.2,this.health<=0&&(this.isDying=!0,this.deathAnimTimer=0)}draw(t){if(!this.alive)return;if(t.save(),t.translate(this.x,this.y),this.isDying){const e=this.deathAnimTimer/.3,i=1-e;t.scale(i,i),t.globalAlpha=1-e}const e=this.damageFlashTimer>0&&Math.floor(20*this.damageFlashTimer)%2==0;switch(t.fillStyle=e?"#ffffff":i,this.faction){case"triangle":this.drawTriangle(t);break;case"square":this.drawSquare(t);break;case"hexagon":this.drawHexagon(t);break;case"diamond":this.drawDiamond(t)}t.restore()}drawTriangle(t){t.beginPath(),t.moveTo(0,this.radius),t.lineTo(this.radius,-this.radius),t.lineTo(-this.radius,-this.radius),t.closePath(),t.fill(),t.strokeStyle="#ffffff",t.lineWidth=1,t.stroke()}drawSquare(t){t.save(),t.rotate(Math.PI/4),t.fillRect(-this.radius,-this.radius,2*this.radius,2*this.radius),t.strokeStyle="#ffffff",t.lineWidth=1,t.strokeRect(-this.radius,-this.radius,2*this.radius,2*this.radius),t.restore()}drawHexagon(t){t.beginPath();for(let e=0;e<6;e++){const i=e/6*Math.PI*2-Math.PI/2,s=Math.cos(i)*this.radius,a=Math.sin(i)*this.radius;0===e?t.moveTo(s,a):t.lineTo(s,a)}t.closePath(),t.fill(),t.strokeStyle="#ffffff",t.lineWidth=1,t.stroke()}drawDiamond(t){t.beginPath(),t.moveTo(0,-this.radius),t.lineTo(.7*this.radius,0),t.lineTo(0,this.radius),t.lineTo(.7*-this.radius,0),t.closePath(),t.fill(),t.strokeStyle="#ffffff",t.lineWidth=1,t.stroke()}}class S extends f{bulletType="player";lifetime=5;timeAlive=0;constructor(){super(),this.radius=3}reset(t,e,i,s,a){super.reset(t,e,i,s,a),this.timeAlive=0}resetWithType(t,e,i,s,a="player"){this.reset(t,e,i,s),this.bulletType=a}update(t){super.update(t),this.timeAlive+=t,this.timeAlive>this.lifetime&&(this.alive=!1)}draw(t){this.alive&&(t.fillStyle="player"===this.bulletType?s:i,t.beginPath(),t.arc(this.x,this.y,this.radius,0,2*Math.PI),t.fill())}}class M{frameTimes=[];fpsCounter=0;lastFpsUpdate=0;currentFps=60;maxFrameTimeP95=16.67;maxSamples=300;recordFrameTime(t){this.frameTimes.push(t),this.frameTimes.length>this.maxSamples&&this.frameTimes.shift()}updateFps(t){this.fpsCounter++,t-this.lastFpsUpdate>=1e3&&(this.currentFps=this.fpsCounter,this.fpsCounter=0,this.lastFpsUpdate=t,this.calculateP95())}calculateP95(){if(0===this.frameTimes.length)return;const t=[...this.frameTimes].sort((t,e)=>t-e),e=Math.ceil(.95*t.length)-1;this.maxFrameTimeP95=t[e]}getFps(){return this.currentFps}getP95FrameTime(){return this.maxFrameTimeP95}getAverageFrameTime(){return 0===this.frameTimes.length?0:this.frameTimes.reduce((t,e)=>t+e,0)/this.frameTimes.length}isFrameBudgetExceeded(t=18){return this.maxFrameTimeP95>t}logMetrics(){return`FPS: ${this.currentFps} | P95: ${this.maxFrameTimeP95.toFixed(2)}ms | Avg: ${this.getAverageFrameTime().toFixed(2)}ms`}}class T{currentWave=0;enemiesSpawned=0;enemiesAlive=0;spawnTimer=0;waveComplete=!1;waveActive=!1;currentPatternIndex=0;patternSpawnCount=0;waveDefinitions=new Map;constructor(){this.setupWaveDefinitions()}setupWaveDefinitions(){this.waveDefinitions.set(1,{patterns:[{faction:"triangle",count:3,spawnDelay:1}],totalEnemies:3}),this.waveDefinitions.set(2,{patterns:[{faction:"triangle",count:2,spawnDelay:.8},{faction:"square",count:3,spawnDelay:1}],totalEnemies:5}),this.waveDefinitions.set(3,{patterns:[{faction:"triangle",count:4,spawnDelay:.7},{faction:"square",count:2,spawnDelay:.9}],totalEnemies:6}),this.waveDefinitions.set(4,{patterns:[{faction:"triangle",count:2,spawnDelay:.6},{faction:"square",count:3,spawnDelay:.8},{faction:"hexagon",count:2,spawnDelay:1.2}],totalEnemies:7}),this.waveDefinitions.set(5,{patterns:[{faction:"triangle",count:4,spawnDelay:.5},{faction:"hexagon",count:3,spawnDelay:1},{faction:"diamond",count:1,spawnDelay:1.5}],totalEnemies:8})}startWave(t){this.currentWave=t,this.enemiesSpawned=0,this.enemiesAlive=0,this.spawnTimer=0,this.waveComplete=!1,this.waveActive=!0,this.currentPatternIndex=0,this.patternSpawnCount=0}update(t,e,i){if(!this.waveActive)return;const s=this.waveDefinitions.get(this.currentWave);if(!s)return this.waveComplete=!0,void(this.waveActive=!1);if(this.enemiesSpawned>=s.totalEnemies)return void(this.enemiesAlive<=0&&(this.waveComplete=!0,this.waveActive=!1));this.spawnTimer+=t;const a=s.patterns[this.currentPatternIndex];if(a&&this.spawnTimer>=a.spawnDelay){this.spawnTimer=0;const t=i*(.2+.6*Math.random()),s=-20,r=e.acquire(t,s,0,150);r&&(r.faction=a.faction,r.reset(t,s,0,150),this.enemiesSpawned++,this.enemiesAlive++,this.patternSpawnCount++,this.patternSpawnCount>=a.count&&(this.currentPatternIndex++,this.patternSpawnCount=0))}}onEnemyDeath(){this.enemiesAlive=Math.max(0,this.enemiesAlive-1)}isWaveComplete(){return this.waveComplete}isWaveActive(){return this.waveActive}getWaveNumber(){return this.currentWave}getWaveProgress(){const t=this.waveDefinitions.get(this.currentWave);return{spawned:this.enemiesSpawned,alive:this.enemiesAlive,total:t?t.totalEnemies:0}}}class P{lootDrops=[];PICKUP_RANGE=50;MAX_LIFETIME=10;spawnLoot(t,e,i,s){const a=this.MAX_LIFETIME,r={x:t,y:e,vx:0,vy:0,radius:5,alive:!0,lootType:i,amount:s,lifetime:0,reset(t,e,i,s){this.x=t,this.y=e,this.vx=i,this.vy=s,this.alive=!0,this.lifetime=0},update(t){this.x+=this.vx*t,this.y+=this.vy*t,this.lifetime+=t,this.lifetime>=a&&(this.alive=!1)},draw(t){this.alive&&(t.save(),t.fillStyle="scrap"===i?"#FFD700":"synergy"===i?"#00BFFF":"#FF00FF",t.beginPath(),t.arc(this.x,this.y,this.radius,0,2*Math.PI),t.fill(),t.restore())}};this.lootDrops.push(r)}update(t){this.lootDrops.forEach(e=>e.update(t)),this.lootDrops=this.lootDrops.filter(t=>t.alive)}collectLoot(t,e){const i=t.radius+this.PICKUP_RANGE;this.lootDrops.forEach(s=>{if(!s.alive)return;const a=s.x-t.x,r=s.y-t.y;Math.sqrt(a*a+r*r)<i&&(e(s.lootType,s.amount),s.alive=!1)})}draw(t){this.lootDrops.forEach(e=>e.draw(t))}clear(){this.lootDrops=[]}getActiveLoot(){return this.lootDrops.filter(t=>t.alive)}}class k{damageThisFrame=new Set;resetFrame(){this.damageThisFrame.clear()}applyPlayerBulletDamage(t,e){const i=`bullet-${t.x}-${t.y}-enemy-${e.x}-${e.y}`;this.damageThisFrame.has(i)||(e.takeDamage(10),t.alive=!1,this.damageThisFrame.add(i))}applyEnemyBulletDamage(t,e){const i=`bullet-${t.x}-${t.y}-player`;this.damageThisFrame.has(i)||(e.takeDamage(5),t.alive=!1,this.damageThisFrame.add(i))}applyEnemyCollisionDamage(t,e){const i=`enemy-${t.x}-${t.y}-player`;this.damageThisFrame.has(i)||(e.takeDamage(10),t.takeDamage(t.maxHealth),this.damageThisFrame.add(i))}}class b{particles=[];MAX_PARTICLES=100;spawnExplosion(t,e,i="#ff1744",s=6){for(let a=0;a<s&&!(this.particles.length>=this.MAX_PARTICLES);a++){const r=a/s*Math.PI*2,h=100+100*Math.random(),n={x:t,y:e,vx:Math.cos(r)*h,vy:Math.sin(r)*h,lifetime:0,maxLifetime:.3+.2*Math.random(),color:i,size:2+2*Math.random(),alive:!0};this.particles.push(n)}}update(t){this.particles.forEach(e=>{e.alive&&(e.x+=e.vx*t,e.y+=e.vy*t,e.lifetime+=t,e.lifetime>=e.maxLifetime&&(e.alive=!1))}),this.particles=this.particles.filter(t=>t.alive)}draw(t){this.particles.forEach(e=>{if(!e.alive)return;const i=1-e.lifetime/e.maxLifetime;t.save(),t.globalAlpha=i,t.fillStyle=e.color,t.beginPath(),t.arc(e.x,e.y,e.size,0,2*Math.PI),t.fill(),t.restore()})}clear(){this.particles=[]}getParticleCount(){return this.particles.length}}class A{canvas;joystickActive=!1;joystickStartX=0;joystickStartY=0;joystickCurrentX=0;joystickCurrentY=0;joystickRadius=50;joystickMaxDistance=40;fireButtonActive=!1;touchIdJoystick=null;touchIdFire=null;input={x:0,y:0,fire:!1};constructor(t){this.canvas=t,this.setupEventListeners()}setupEventListeners(){this.canvas.addEventListener("touchstart",this.handleTouchStart.bind(this),{passive:!1}),this.canvas.addEventListener("touchmove",this.handleTouchMove.bind(this),{passive:!1}),this.canvas.addEventListener("touchend",this.handleTouchEnd.bind(this),{passive:!1}),this.canvas.addEventListener("touchcancel",this.handleTouchEnd.bind(this),{passive:!1})}handleTouchStart(t){const e=t;e.preventDefault();const i=this.canvas.getBoundingClientRect();for(let s=0;s<e.changedTouches.length;s++){const t=e.changedTouches[s],a=t.clientX-i.left,r=t.clientY-i.top;a<i.width/2&&null===this.touchIdJoystick?(this.touchIdJoystick=t.identifier,this.joystickActive=!0,this.joystickStartX=a,this.joystickStartY=r,this.joystickCurrentX=a,this.joystickCurrentY=r):a>=i.width/2&&null===this.touchIdFire&&(this.touchIdFire=t.identifier,this.fireButtonActive=!0)}}handleTouchMove(t){const e=t;e.preventDefault();const i=this.canvas.getBoundingClientRect();for(let s=0;s<e.changedTouches.length;s++){const t=e.changedTouches[s];t.identifier===this.touchIdJoystick&&(this.joystickCurrentX=t.clientX-i.left,this.joystickCurrentY=t.clientY-i.top)}}handleTouchEnd(t){const e=t;e.preventDefault();for(let i=0;i<e.changedTouches.length;i++){const t=e.changedTouches[i];t.identifier===this.touchIdJoystick?(this.joystickActive=!1,this.touchIdJoystick=null,this.input.x=0,this.input.y=0):t.identifier===this.touchIdFire&&(this.fireButtonActive=!1,this.touchIdFire=null)}}update(){if(this.joystickActive){const t=this.joystickCurrentX-this.joystickStartX,e=this.joystickCurrentY-this.joystickStartY,i=Math.sqrt(t*t+e*e);if(i>5){const s=Math.min(i,this.joystickMaxDistance);this.input.x=t/i*(s/this.joystickMaxDistance),this.input.y=e/i*(s/this.joystickMaxDistance)}else this.input.x=0,this.input.y=0}this.input.fire=this.fireButtonActive}draw(t){if(this.joystickActive||this.fireButtonActive){if(t.save(),this.joystickActive&&(t.strokeStyle="rgba(255, 255, 255, 0.3)",t.lineWidth=2,t.beginPath(),t.arc(this.joystickStartX,this.joystickStartY,this.joystickRadius,0,2*Math.PI),t.stroke(),t.fillStyle="rgba(0, 255, 136, 0.6)",t.beginPath(),t.arc(this.joystickCurrentX,this.joystickCurrentY,20,0,2*Math.PI),t.fill()),this.fireButtonActive){const e=t.canvas.width-80,i=t.canvas.height-80;t.fillStyle="rgba(255, 23, 68, 0.6)",t.beginPath(),t.arc(e,i,40,0,2*Math.PI),t.fill(),t.strokeStyle="rgba(255, 255, 255, 0.4)",t.lineWidth=2,t.beginPath(),t.arc(e,i,40,0,2*Math.PI),t.stroke()}t.restore()}}}class C{renderer;gameState;inputHandler;touchControls;audioManager;collisionSystem;performanceMonitor;waveManager;lootManager;damageCalculator;effectManager;playerPool;enemyPool;bulletPool;player=null;debugMode=!1;lastFrameTime=0;waveTransitionTimer=0;gameOverTimer=0;isGameOver=!1;showWaveTransition=!1;waveTransitionFade=0;constructor(){this.renderer=new u("game"),this.gameState=new m,this.inputHandler=new p(this.renderer.canvas),this.touchControls=new A(this.renderer.canvas),this.audioManager=new g,this.collisionSystem=new y,this.performanceMonitor=new M,this.waveManager=new T,this.lootManager=new P,this.damageCalculator=new k,this.effectManager=new b,this.playerPool=new v(l,()=>new x),this.enemyPool=new v(c,()=>new w),this.bulletPool=new v(d,()=>new S),this.player=this.playerPool.acquire(this.renderer.getWidth()/2,this.renderer.getHeight()-50,0,0),this.setupKeyboardEvents(),this.setupResume()}setupKeyboardEvents(){window.addEventListener("keydown",t=>{"d"===t.key.toLowerCase()&&(this.debugMode=!this.debugMode)})}setupResume(){window.addEventListener("pointerdown",()=>{this.audioManager.resumeContext()}),window.addEventListener("keydown",()=>{this.audioManager.resumeContext()})}start(){this.gameState.startRun(),this.audioManager.loadAndCacheAudio("fire","/audio/sfx/fire.mp3"),this.audioManager.loadAndCacheAudio("hit","/audio/sfx/hit.mp3"),this.audioManager.loadAndCacheAudio("upgrade","/audio/sfx/upgrade.mp3"),this.audioManager.loadAndCacheAudio("music","/audio/music.mp3"),window.setTimeout(()=>{this.audioManager.playMusicByKey("music",!0)},500),this.waveManager.startWave(1),this.lastFrameTime=performance.now(),requestAnimationFrame(this.gameLoop.bind(this))}gameLoop=t=>{const e=Math.min((t-this.lastFrameTime)/1e3,.016);this.lastFrameTime=t;const i=performance.now();this.update(e),this.render();const s=performance.now()-i;this.performanceMonitor.recordFrameTime(s),this.performanceMonitor.updateFps(t),requestAnimationFrame(this.gameLoop.bind(this))};update(t){if(this.isGameOver){this.gameOverTimer+=t;return void(this.inputHandler.getInput().fire&&this.gameOverTimer>1&&this.restart())}if(!this.player?.alive)return void this.handleGameOver();if(this.damageCalculator.resetFrame(),this.waveManager.update(t,this.enemyPool,this.renderer.getWidth()),this.waveManager.isWaveComplete())return this.waveTransitionTimer+=t,this.showWaveTransition=!0,this.waveTransitionTimer<.5?this.waveTransitionFade=2*this.waveTransitionTimer:this.waveTransitionFade=2-2*this.waveTransitionTimer,void(this.waveTransitionTimer>=1&&(this.gameState.nextWave(),this.waveManager.startWave(this.gameState.wave),this.waveTransitionTimer=0,this.showWaveTransition=!1));this.touchControls.update();const e=this.inputHandler.getInput(),i=this.touchControls.input,s=e.x||i.x,a=e.y||i.y,r=e.fire||i.fire;if(this.player.updateInput(s,a),this.player.x=Math.max(this.player.radius,Math.min(this.renderer.getWidth()-this.player.radius,this.player.x)),this.player.y=Math.max(this.player.radius,Math.min(this.renderer.getHeight()-this.player.radius,this.player.y)),this.player.update(t),this.enemyPool.update(t),this.bulletPool.update(t),this.lootManager.update(t),this.effectManager.update(t),this.handleCollisions(),this.lootManager.collectLoot(this.player,(t,e)=>{this.gameState.addResources(t,e),this.audioManager.playSfxByKey("upgrade")}),r&&this.player.canFire()){this.player.fire(),this.audioManager.playSfxByKey("fire");const t=this.bulletPool.acquire(this.player.x,this.player.y,300*Math.cos(this.player.aimAngle),300*Math.sin(this.player.aimAngle));t&&t.resetWithType(this.player.x,this.player.y,300*Math.cos(this.player.aimAngle),300*Math.sin(this.player.aimAngle),"player")}this.enemyPool.getActive().forEach(t=>{if(t.canFire()){t.fire();const e=Math.atan2(this.player.y-t.y,this.player.x-t.x),i=this.bulletPool.acquire(t.x,t.y,200*Math.cos(e),200*Math.sin(e));i&&i.resetWithType(t.x,t.y,200*Math.cos(e),200*Math.sin(e),"enemy")}}),this.removeOutOfBounds()}handleCollisions(){const t=this.bulletPool.getActive().filter(t=>"player"===t.bulletType),e=this.bulletPool.getActive().filter(t=>"enemy"===t.bulletType),i=this.enemyPool.getActive();t.forEach(t=>{i.forEach(e=>{const i=t.x-e.x,s=t.y-e.y;Math.sqrt(i*i+s*s)<t.radius+e.radius&&(this.damageCalculator.applyPlayerBulletDamage(t,e),e.health<=0&&this.onEnemyDeath(e))})}),this.player&&(e.forEach(t=>{const e=t.x-this.player.x,i=t.y-this.player.y;Math.sqrt(e*e+i*i)<t.radius+this.player.radius&&(this.damageCalculator.applyEnemyBulletDamage(t,this.player),this.gameState.onPlayerHit())}),i.forEach(t=>{const e=t.x-this.player.x,i=t.y-this.player.y;Math.sqrt(e*e+i*i)<t.radius+this.player.radius&&(this.damageCalculator.applyEnemyCollisionDamage(t,this.player),this.gameState.onPlayerHit())}))}onEnemyDeath(t){this.gameState.addScore(100),this.audioManager.playSfxByKey("hit"),this.effectManager.spawnExplosion(t.x,t.y,i,8),this.lootManager.spawnLoot(t.x,t.y,"scrap",t.loot.scrap),t.loot.synergy>0&&this.lootManager.spawnLoot(t.x,t.y,"synergy",t.loot.synergy),this.waveManager.onEnemyDeath(),t.alive=!1}removeOutOfBounds(){const t=this.renderer.getWidth(),e=this.renderer.getHeight();this.bulletPool.getActive().forEach(i=>{(i.x<-20||i.x>t+20||i.y<-20||i.y>e+20)&&(i.alive=!1)}),this.enemyPool.getActive().forEach(t=>{t.y>e+50&&(t.alive=!1,this.waveManager.onEnemyDeath())})}handleGameOver(){this.isGameOver=!0,this.gameOverTimer=0,this.gameState.endRun(),this.audioManager.stopMusic()}restart(){this.isGameOver=!1,this.gameOverTimer=0,this.waveTransitionTimer=0,this.enemyPool.clear(),this.bulletPool.clear(),this.lootManager.clear(),this.effectManager.clear(),this.player=this.playerPool.acquire(this.renderer.getWidth()/2,this.renderer.getHeight()-50,0,0),this.player&&this.player.reset(this.renderer.getWidth()/2,this.renderer.getHeight()-50),this.gameState.startRun(),this.waveManager.startWave(1),window.setTimeout(()=>{this.audioManager.playMusicByKey("music",!0)},200)}render(){if(this.renderer.clear(),this.lootManager.draw(this.renderer.getContext()),this.effectManager.draw(this.renderer.getContext()),this.player?.alive&&this.player.draw(this.renderer.getContext()),this.enemyPool.draw(this.renderer.getContext()),this.bulletPool.draw(this.renderer.getContext()),this.renderer.drawText(`Wave: ${this.gameState.wave}`,10,20,16,a),this.renderer.drawText(`Score: ${this.gameState.score} (Ã—${this.gameState.multiplier.toFixed(1)})`,10,40,16,a),this.renderer.drawText(`Scrap: ${this.gameState.resources.scrap} | Synergy: ${this.gameState.resources.synergy}`,10,60,16,a),this.player){const t=this.player.health/this.player.maxHealth,e=150,i=10,s=this.renderer.getWidth()-e-10,r=10,h=this.renderer.getContext();h.fillStyle="#333",h.fillRect(s,r,e,i),h.fillStyle=t>.5?"#00ff88":t>.25?"#ffeb3b":"#ff1744",h.fillRect(s,r,e*t,i),h.strokeStyle="#fff",h.strokeRect(s,r,e,i),this.renderer.drawText(`HP: ${this.player.health}/${this.player.maxHealth}`,s,r-5,12,a)}if(this.showWaveTransition){const t=this.renderer.getContext();t.save(),t.globalAlpha=this.waveTransitionFade,t.fillStyle="rgba(0, 0, 0, 0.5)",t.fillRect(0,0,this.renderer.getWidth(),this.renderer.getHeight()),this.renderer.drawText(`Wave ${this.gameState.wave+1}`,this.renderer.getWidth()/2-60,this.renderer.getHeight()/2,36,e),t.restore()}if(this.isGameOver){const t=this.renderer.getContext();t.fillStyle="rgba(0, 0, 0, 0.7)",t.fillRect(0,0,this.renderer.getWidth(),this.renderer.getHeight()),this.renderer.drawText("GAME OVER",this.renderer.getWidth()/2-80,this.renderer.getHeight()/2-60,32,r),this.renderer.drawText(`Final Score: ${this.gameState.score}`,this.renderer.getWidth()/2-100,this.renderer.getHeight()/2-10,20,a),this.renderer.drawText(`Best Score: ${this.gameState.bestScore}`,this.renderer.getWidth()/2-90,this.renderer.getHeight()/2+20,18,a),this.gameOverTimer>1&&this.renderer.drawText("Press SPACE to retry",this.renderer.getWidth()/2-95,this.renderer.getHeight()/2+60,16,e)}this.touchControls.draw(this.renderer.getContext()),this.debugMode&&(this.renderer.drawText(`FPS: ${this.performanceMonitor.getFps()}`,10,this.renderer.getHeight()-80,14,r),this.renderer.drawText(`P95: ${this.performanceMonitor.getP95FrameTime().toFixed(2)}ms`,10,this.renderer.getHeight()-60,14,r),this.renderer.drawText(`Entities: ${this.enemyPool.getActive().length+this.bulletPool.getActive().length+this.lootManager.getActiveLoot().length+this.effectManager.getParticleCount()}`,10,this.renderer.getHeight()-40,14,r),this.renderer.drawText(`Wave Progress: ${this.waveManager.getWaveProgress().alive}/${this.waveManager.getWaveProgress().total}`,10,this.renderer.getHeight()-20,14,r))}}document.addEventListener("DOMContentLoaded",()=>{(new C).start()});
//# sourceMappingURL=index.C3tsKPOc.js.map
